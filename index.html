<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Bayraktar 3D</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
    #loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-family: Arial; font-size: 18px;
    }
    #hud {
      position: absolute; top: 10px; left: 10px;
      color: white; font-family: Arial; font-size: 14px;
      background: rgba(0, 0, 0, 0.4); padding: 8px; border-radius: 4px;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
<div id="loading">Завантаження моделі: <span id="progress">0%</span></div>
<div id="hud">Цілі знищено: <span id="score">0</span></div>
<audio id="engineSound" src="diesel-drive-by-3-mz000007-47135.mp3" loop></audio>
<audio id="startSound" src="engine-start-86242.mp3"></audio>
<audio id="missileSound" src="missile-firing-fl-106655.mp3"></audio>
<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

let scene, camera, renderer, controls, bayraktar, propeller = null;
let score = 0, keys = {}, missiles = [], targets = [];
let hasTakenOff = false, engineOn = false, cameraMode = 2, rpm = 0;

scene = new THREE.Scene();
scene.background = new THREE.Color(0x202840);

camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 2, 8);

renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0, 1, 0);
controls.update();

const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444);
hemiLight.position.set(0, 20, 0);
scene.add(hemiLight);

const dirLight = new THREE.DirectionalLight(0xffffff);
dirLight.position.set(-3, 10, -10);
scene.add(dirLight);

const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200, 200),
  new THREE.MeshStandardMaterial({ color: 0x224422 })
);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

const loader = new GLTFLoader();
loader.load('bayraktar.glb',
  function (gltf) {
    bayraktar = gltf.scene;
    bayraktar.scale.set(0.03, 0.03, 0.03);
    bayraktar.position.set(0, 0.25, 0);
    bayraktar.traverse((child) => {
      if (child.isMesh) {
        child.castShadow = true;
        if (child.name.toLowerCase().includes('prop') || child.name.toLowerCase().includes('винт')) {
          propeller = child;
        }
      }
    });
    scene.add(bayraktar);
    document.getElementById('loading').style.display = 'none';
    spawnTargets();
  },
  function (xhr) {
    const percent = Math.round((xhr.loaded / xhr.total) * 100);
    document.getElementById('progress').textContent = percent + '%';
  },
  function (error) {
    console.error('Помилка завантаження:', error);
  }
);

function spawnTargets() {
  for (let i = 0; i < 10; i++) {
    const target = new THREE.Mesh(
      new THREE.BoxGeometry(0.5, 0.5, 0.5),
      new THREE.MeshStandardMaterial({ color: 0xffaa00 })
    );
    target.position.set(Math.random() * 50 - 25, 0.25, -Math.random() * 100 - 60);
    targets.push(target);
    scene.add(target);
  }
}

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

window.addEventListener('keydown', (e) => {
  keys[e.key.toLowerCase()] = true;
  if (e.key === 'r') toggleEngine();
  if (e.key === ' ' && engineOn) shootMissile();
  if (e.key === '1') cameraMode = 1;
  if (e.key === '2') cameraMode = 2;
  if (e.key === '3') cameraMode = 3;
});

window.addEventListener('keyup', (e) => {
  keys[e.key.toLowerCase()] = false;
});

function toggleEngine() {
  engineOn = !engineOn;
  if (engineOn) {
    document.getElementById('startSound').play();
    document.getElementById('engineSound').play();
    hasTakenOff = true;
  } else {
    document.getElementById('engineSound').pause();
    rpm = 0;
  }
}

function moveBayraktar() {
  if (!bayraktar || !engineOn) return;
  const speed = 0.05;
  if (keys['w']) bayraktar.position.z -= speed;
  if (keys['s']) bayraktar.position.z += speed;
  if (keys['a']) bayraktar.position.x -= speed;
  if (keys['d']) bayraktar.position.x += speed;
  if (keys['q']) bayraktar.rotation.y += 0.03;
  if (keys['e']) bayraktar.rotation.y -= 0.03;
}

function shootMissile() {
  const missile = new THREE.Mesh(
    new THREE.CylinderGeometry(0.02, 0.02, 0.5),
    new THREE.MeshBasicMaterial({ color: 0xff0000 })
  );
  missile.rotation.x = Math.PI / 2;
  missile.position.copy(bayraktar.position);
  scene.add(missile);
  missiles.push(missile);
  document.getElementById('missileSound').currentTime = 0;
  document.getElementById('missileSound').play();
}

function updateMissiles() {
  missiles.forEach((missile, i) => {
    missile.position.z -= 0.2;
    targets.forEach((target, j) => {
      if (missile.position.distanceTo(target.position) < 0.5) {
        scene.remove(target);
        scene.remove(missile);
        targets.splice(j, 1);
        missiles.splice(i, 1);
        score++;
        document.getElementById('score').textContent = score;
      }
    });
    if (missile.position.z < -200) {
      scene.remove(missile);
      missiles.splice(i, 1);
    }
  });
}

function updateCamera() {
  if (!bayraktar) return;
  if (cameraMode === 1) {
    const tailPosition = new THREE.Vector3(0, 1.5, 4).applyMatrix4(bayraktar.matrixWorld); // Вгору і ззаду
    const lookAtPosition = new THREE.Vector3(0, 1, 0).applyMatrix4(bayraktar.matrixWorld); // Зорієнтувати камеру на центр
    camera.position.lerp(tailPosition, 0.1);
    camera.lookAt(lookAtPosition);
  } else if (cameraMode === 2) {
    const behind = new THREE.Vector3(0, 2, 8).applyMatrix4(bayraktar.matrixWorld);
    camera.position.lerp(behind, 0.1);
    camera.lookAt(bayraktar.position);
  } else if (cameraMode === 3) {
    controls.enabled = true;
    controls.target.copy(bayraktar.position);
    controls.update();
  }
}

function animate() {
  requestAnimationFrame(animate);
  if (engineOn && propeller) {
    rpm = 5500; // Наприклад, режим злету
    propeller.rotation.y += 0.5;
  }
  moveBayraktar();
  updateMissiles();
  updateCamera();
  renderer.render(scene, camera);
}

animate();
</script>
</body>
</html>
